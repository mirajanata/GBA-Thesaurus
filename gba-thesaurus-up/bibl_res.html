<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GBA Thesaurus | Bibliographic Resources</title>
    <!--<link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>-->
    <link rel="stylesheet" href="https://bootswatch.com/4/simplex/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

    <script src="js/ws.js"></script>
    <style type="text/css">
        html {
            height: 100%;
            margin: 0px;
        }

        body {
            height: 90%;
            margin: 0px;
        }

        .capHeader {
            font-size: 48px;
        }
        .list-group {
            border: 1px solid #eeeeee;
            -webkit-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
            -moz-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
            box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
            margin:10px;
        }
        .list-group-item {
            margin-bottom: 5px;
            border: none !important;
        }
    </style>
    <script>
        $(document).ready(function () {
            let urlParams = new URLSearchParams(window.location.search);
            let thesProjName = urlParams.get('proj');
            //$('#headRef').text(`Bibliographic references used for ${thesProjName}`);
            //console.log(urlParams.get('uri')); // "http.."
            let query1 = encodeURIComponent(`PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
                                                        PREFIX dcterms:<http://purl.org/dc/terms/>
                                                        SELECT DISTINCT ?o
                                                        WHERE {
                                                        ?s dcterms:references ?o
                                                        }`);
            let query2 = encodeURIComponent(`PREFIX dcterms:<http://purl.org/dc/terms/>
                                                        SELECT DISTINCT *
                                                        WHERE {
                                                        ?s dcterms:bibliographicCitation ?C
                                                        OPTIONAL {?s dcterms:source ?pdf}
                                                        OPTIONAL {?s dcterms:identifier ?id}
                                                        }
                                                        ORDER BY ?C`);

            let url = `${ws.endpoint}${thesProjName}?query=${query1}&format=application/json`;
            let refs = [];


            let result = fetch(url, {
                method: 'get',
            }).then(function (response) {
                return response.json();
            }).then(function (data) {
                refs = Array.from(data.results.bindings, a => (a.o.value));
                //console.log(refs);
                return fetch(`${ws.endpoint}ref?query=${query2}&format=application/json`);
            })
                .then(function (response) {
                    return response.json();
                })
                .catch(function (error) {
                    console.log('Request failed', error);
                });

            result.then(function (r) {
                let firstChar = '§';
                let ariaExp = true;
                let collapse = '';
                let count = 0;
                let toolBar = $("#biblrefToolbar");
                let refList = $("#refList");
                let done = "", c1="";

                for (let i of r.results.bindings) {
                    if (refs.includes(i.s.value)) {
                        count ++;
                        let idx = '';
                        let pdfx = '';
                        //console.log(i);
                        if (i.hasOwnProperty('pdf')) {
                            pdfx = ` <a href="${i.pdf.value}">[PDF]</a>`;
                        }
                        if (i.hasOwnProperty('id')) {
                            idx = ` <a href="https://opac.geologie.ac.at/document/${i.id.value}">[Catalog]</a>`;
                        }
                        let citArr = i.C.value.split(':');
                        let listGroupItem = `<li class="list-group-item">
                                                            <strong>${citArr[0]}:</strong>
                                                            ${citArr.slice(1).join()} ${pdfx}${idx}
                                                    </li>`;

                        if (i.C.value.charAt(0).toUpperCase() == firstChar) {
                            $(`#ref${firstChar} ul`).append(listGroupItem);
                        } else {
                            firstChar = i.C.value.charAt(0).toUpperCase();
                            if (c1 == "")
                                c1 = firstChar;
                            if (done.indexOf(firstChar) < 0) {
                                done += firstChar;
                                toolBar.append(`<div class="panel-heading" role="tab" id="refHeading${firstChar}">
                                                            <button id="btn${firstChar}" type="button" class="btn btn-outline-info btexpand"  style="font-size:18px;margin:10px;" onclick="expand('${firstChar}');">
                                                                    ${firstChar}
                                                                </button>
                                                            </div>
                                                        </div>`);
                                refList.append(`<div id="ref${firstChar}" class="panel-collapse collapse${collapse}" role="tabpanel" aria-labelledby="refHeading${firstChar}">
                                                            <ul class="list-group">
<li class="list-group-item">
                            <h1 class="text-danger capHeader" >${firstChar}</h1>
</li>
                                                                ${listGroupItem}
                                                            </ul>
                                                        </div>`);
                                ariaExp = false;
                            }
                        }
                    }
                }
                onResize();
                if (count < 10) {
                    expandAll();
                } else if (c1 != "")
                    expand(c1);
            });
        });
        let expanded = false;
        function expand(id) {
            var e = $("#ref" + id);
            var btn = $("#btn" + id);
            var vis = e.hasClass("show");
            if (vis) {
                e.attr("aria-expanded", "false");
                e.attr("class", "panel-collapse collapse hide");
                btn.removeClass("btn-info");
                btn.addClass("btn-outline-info");
            } else {
                e.attr("aria-expanded", "true");
                e.attr("class", "panel-collapse collapse show");
                e.attr("class", "panel-collapse collapse show");
                btn.removeClass("btn-outline-info");
                btn.addClass("btn-info");
            }
            //$('#expBut').hide();
        }
        function expandAll() {
            expanded = !expanded;
            if (expanded) {
                $('.collapsed').attr("aria-expanded", "true");
                $('.panel-collapse').attr("class", "panel-collapse collapse show");
                $('#expBut').text("Collapse All");
                $(".btexpand").removeClass("btn-outline-info");
                $(".btexpand").addClass("btn-info");
            } else {
                $('.collapsed').attr("aria-expanded", "false");
                $('.panel-collapse').attr("class", "panel-collapse collapse hide");
                $('#expBut').text("Expand All");
                $(".btexpand").removeClass("btn-info");
                $(".btexpand").addClass("btn-outline-info");
            }
            //$('#expBut').hide();
        }
        function onResize() {
            var h = $('#biblrefContainer').height();
            var dh = $('#biblrefToolbar').height();
            console.log(dh);
            $('#tabList').height(h - dh - (dh/2));
        }
    </script>
</head>

<body onload="onResize();" onresize="onResize();">
    <div class="container-fluid" style="height:100%;">
        <div class="row no-gutters" style="height:100%;">
            <div id="one" class="card" style="width:100%;">
                <a href="https://www.geologie.ac.at"><img alt="GBA Thesaurus" id="IMG_GBALOGO" src="img/gbaLogo50.png" height="35"></a>
                <div class="card-header" style="height:70px;"><h1>GBA - Bibliographic reference</h1></div>
                <div id="biblrefContainer" class="card-body">
                    <div id="biblrefToolbar" style="margin-bottom:5px;" class="input-group bg-dark input-group-text">
                        <button type="button" id="expBut" class="btn btn-primary" onclick="expandAll()" style="margin-right:20px;">Expand All</button>
                    </div>
                    <div id="tabList" class="panel-group" role="tablist" style="overflow-y:auto">
                        <div class="panel panel-default" id="refList"> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
